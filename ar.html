document.addEventListener("DOMContentLoaded", async () => {
  const sceneEl = document.querySelector("a-scene");
  let arData = [];

  try {
    // 1Ô∏è‚É£ Cargar datos desde el archivo JSON
    const response = await fetch("./js/ar-data.json");
    arData = await response.json();
    console.log("‚úÖ Datos de AR cargados:", arData);

    // 2Ô∏è‚É£ Esperar a que la escena de A-Frame est√© completamente lista
    await new Promise(resolve => {
      if (sceneEl.hasLoaded) resolve();
      else sceneEl.addEventListener("loaded", resolve);
    });
    console.log("üé¨ Escena A-Frame lista.");

    // 3Ô∏è‚É£ Crear din√°micamente los targets basados en los datos del JSON
    arData.forEach((data, index) => {
      const target = document.createElement("a-entity");
      target.setAttribute("id", `target-${index}`);
      target.setAttribute("mindar-image-target", `targetIndex: ${index}`);
      sceneEl.appendChild(target);
    });
    console.log(`üß© ${arData.length} targets creados en la escena.`);

    // 4Ô∏è‚É£ Construir elementos visuales (men√∫s, paneles, etc.)
    buildARScene(arData);

    // 5Ô∏è‚É£ Agregar eventos de detecci√≥n a cada target
    arData.forEach((_, index) => {
      const targetEl = document.getElementById(`target-${index}`);

      targetEl.addEventListener("targetFound", () => {
        console.log(`üéØ Target ${index} detectado`);
        showMenu(index);
      });

      targetEl.addEventListener("targetLost", () => {
        console.log(`‚ùå Target ${index} perdido`);
        const menu = document.querySelector(`#menu-container-${index}`);
        const content = document.querySelector(`#content-container-${index}`);
        if (menu) menu.setAttribute("visible", "false");
        if (content) content.setAttribute("visible", "false");
      });
    });

  } catch (error) {
    console.error("‚ùå Error al inicializar el sistema AR:", error);
  }
});

/* ===========================================================
   FUNCIONES AUXILIARES
   =========================================================== */

// Crear los elementos de men√∫, texto, im√°genes, etc.
function buildARScene(arData) {
  const sceneEl = document.querySelector("a-scene");

  arData.forEach((data, index) => {
    const targetEl = document.getElementById(`target-${index}`);
    if (!targetEl) return;

    // Contenedor de men√∫ (invisible al inicio)
    const menuContainer = document.createElement("a-entity");
    menuContainer.setAttribute("id", `menu-container-${index}`);
    menuContainer.setAttribute("visible", "false");
    menuContainer.setAttribute("position", "0 0 0");

    // Ejemplo de texto de pa√≠s
    const textEl = document.createElement("a-text");
    textEl.setAttribute("value", data.nombre || `Pa√≠s ${index + 1}`);
    textEl.setAttribute("align", "center");
    textEl.setAttribute("position", "0 0.1 0");
    textEl.setAttribute("color", "#FFD700");
    textEl.setAttribute("width", "2");

    menuContainer.appendChild(textEl);
    targetEl.appendChild(menuContainer);
  });

  console.log("üì¶ Men√∫s generados para todos los targets.");
}

// Mostrar el men√∫ del pa√≠s detectado
function showMenu(index) {
  const menu = document.querySelector(`#menu-container-${index}`);
  if (menu) {
    menu.setAttribute("visible", "true");
  }

  const content = document.querySelector(`#content-container-${index}`);
  if (content) {
    content.setAttribute("visible", "true");
  }
}
